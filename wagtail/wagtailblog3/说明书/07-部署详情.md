# **博客系统 - 部署详情指南**

## **1. 部署模式选择**

根据服务器环境，我们提供两种经过验证的部署方案：

1.  **Docker 容器化部署 (推荐)**: 环境隔离最好，部署最快，适合云原生环境。
2.  **Conda + uWSGI 原生部署**: 适合宝塔面板或已有 Anaconda 环境的服务器，性能调优更灵活。

## **2. 方案 A: Docker 容器化部署详情**

### **2.1 构建镜像**
在项目根目录下（包含 `Dockerfile` 的位置）执行：

```bash
# 构建镜像，命名为 wagtailblog:v2
docker build -t wagtailblog:v2 .
```

### **2.2 准备环境文件**

创建生产环境配置文件 `.env.prod`：

```ini
DJANGO_SETTINGS_MODULE=wagtailblog3.settings.production
SECRET_KEY=prod_secret_key_change_me
# ... (参考 05-手册 中的完整配置)
# 确保数据库和Redis指向宿主机IP或Docker网络中的别名
DB_HOST=172.17.0.1 
REDIS_HOST=172.17.0.1
```

### **2.3 启动容器**

使用 Gunicorn 作为应用服务器（`Dockerfile` 默认指令）：

```bash
docker run -d \
  --name wagtail_prod \
  --restart always \
  -p 8000:8000 \
  --env-file .env.prod \
  -v /www/wagtailblog/media:/app/media \
  -v /www/wagtailblog/static:/app/staticfiles_collected \
  wagtailblog:v2
```

### **2.4 Nginx 反向代理 (Docker版)**

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    # 静态文件直接由 Nginx 处理 (映射到宿主机挂载目录)
    location /static/ {
        alias /www/wagtailblog/static/;
    }

    location /media/ {
        alias /www/wagtailblog/media/;
    }

    # 动态请求转发给 Gunicorn
    location / {
        proxy_pass [http://127.0.0.1:8000](http://127.0.0.1:8000);
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

-----

## **3. 方案 B: Conda + uWSGI 原生部署 (基于 start.sh)**

此方案基于代码库中的 `uwsgi.ini` 和 `start.sh`，适用于**宝塔面板**或手动管理的 Linux 环境。

### **3.1 环境准备**

1.  **安装 Anaconda/Miniconda**: 确保安装在 `/root/anaconda3` (或修改 `start.sh` 中的路径)。
2.  **创建环境**:
    ```bash
    conda create -n wagtailblog python=3.12
    conda activate wagtailblog
    pip install -r requirements.txt
    pip install uwsgi  # 必须单独安装
    ```

### **3.2 配置文件修正 (`uwsgi.ini`)**

代码库中的 `uwsgi.ini` 需要根据实际路径进行确认：

```ini
[uwsgi]
# 1. 修改为实际项目路径
chdir=/home/wagtail_user/wagtailblog3

# 2. 虚拟环境路径 (Conda)
home=/root/anaconda3/envs/wagtailblog

# 3. 通信方式 (生产环境推荐 Socket)
socket=%(chdir)/wagtailblog3.sock
chmod-socket=666

# 4. 日志路径 (确保目录存在)
daemonize=%(chdir)/logs/uwsgi.log
```

### **3.3 启动脚本 (`start.sh`)**

赋予脚本执行权限并运行：

```bash
chmod +x start.sh
./start.sh
```

*注意：`start.sh` 使用 `exec uwsgi` 方式启动，这使得 uWSGI 进程替换当前的 shell 进程，便于进程管理工具（如 Supervisor 或宝塔进程守护）监控。*

### **3.4 Nginx 配置 (uWSGI Socket版)**

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location /static/ {
        alias /home/wagtail_user/wagtailblog3/staticfiles_collected/;
    }

    location / {
        include uwsgi_params;
        # 必须与 uwsgi.ini 中的 socket 路径完全一致
        uwsgi_pass unix:/home/wagtail_user/wagtailblog3/wagtailblog3.sock;
    }
}
```

## **4. 关键维护操作详解**

### **4.1 静态文件更新**

每次修改 CSS/JS 后，必须执行：

```bash
# Docker 环境
docker exec wagtail_prod python manage.py collectstatic --noinput

# Conda 环境
python manage.py collectstatic --noinput
```

### **4.2 数据库迁移**

修改模型 (`models.py`) 后：

```bash
# Docker 环境
docker exec wagtail_prod python manage.py migrate

# Conda 环境
python manage.py migrate
```

### **4.3 AI 功能调试**

如果 DeepSeek/Qwen 接口报错，请检查服务器出站连接：

```bash
# 测试连通性
curl -I [https://api.deepseek.com](https://api.deepseek.com)
```

若超时，检查服务器防火墙或 DNS 设置。

* 