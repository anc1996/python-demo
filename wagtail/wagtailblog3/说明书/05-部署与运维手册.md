# **博客系统 - 部署与运维手册**

**版本: 2.0**

**日期: 2025-06-14**

**修订人: System Architect**



## **1. 引言 (Introduction)**

### **1.1 目的 (Purpose)**
本手册旨在为系统管理员和 DevOps 工程师提供 Wagtail 博客系统的标准部署指引。文档涵盖了 **Docker 容器化部署**（推荐）和 **传统 Linux 部署**（支持 Gunicorn/uWSGI）两种模式，以及生产环境的配置与维护策略。

### **1.2 目标读者**
* 熟悉 Linux/Docker 的运维人员。
* 需要在云服务器或宝塔面板部署本项目的开发人员。



## **2. 系统环境与依赖**

### **2.1 核心依赖矩阵**

| 组件           | 要求版本                       | 说明                               |
| :------------- | :----------------------------- | :--------------------------------- |
| **操作系统**   | Linux (Debian 12/Ubuntu 22.04) | Docker 模式下 OS 不限              |
| **Python**     | 3.12+                          | `Dockerfile` 基于 3.12-slim        |
| **数据库**     | MySQL 8.0+                     | 存储元数据 (需 `mysqlclient` 支持) |
| **内容存储**   | MongoDB 5.0+                   | 存储富文本正文 (StreamField)       |
| **缓存/队列**  | Redis 6.0+                     | 缓存及 Celery Broker               |
| **对象存储**   | MinIO / S3 Compatible          | 存储媒体文件 (图片/文档)           |
| **Web 服务器** | Nginx                          | 反向代理与静态文件服务             |
| **应用服务器** | Gunicorn (Docker默认) / uWSGI  | WSGI 容器                          |

## **3. 配置管理 (Configuration)**

无论采用何种部署方式，环境变量都是配置系统的核心。

### **3.1 环境变量文件 (`.env`)**
在项目根目录创建 `.env` 文件。**注意：此文件包含敏感密钥，严禁提交到代码仓库。**

```ini
# ==============================================
# 基础 Django 配置
# ==============================================
DJANGO_SETTINGS_MODULE=wagtailblog3.settings.production
SECRET_KEY='change-me-to-a-very-long-random-string-in-production'
DEBUG=False
ALLOWED_HOSTS=yourdomain.com,[www.yourdomain.com](https://www.yourdomain.com),127.0.0.1

# ==============================================
# 数据库连接 (MySQL)
# ==============================================
DB_NAME=wagtailblog
DB_USER=blog_user
DB_PASSWORD=complex_password
DB_HOST=mysql_host
DB_PORT=3306

# ==============================================
# 搜索引擎与内容存储 (MongoDB)
# ==============================================
MONGO_HOST=mongo_host
MONGO_PORT=27017
MONGO_DB_NAME=wagtail_content
MONGO_USER=root  # 可选
MONGO_PASSWORD=mongo_password  # 可选

# ==============================================
# 缓存与消息队列 (Redis)
# ==============================================
REDIS_HOST=redis_host
REDIS_PORT=6379
REDIS_PASSWORD=redis_password
# 用于 Celery Broker 和 Django Cache
REDIS_URL=redis://:redis_password@redis_host:6379/0

# ==============================================
# 对象存储 (MinIO / S3)
# ==============================================
AWS_STORAGE_BUCKET_NAME=wagtail-media
AWS_S3_ENDPOINT_URL=[https://minio.yourdomain.com](https://minio.yourdomain.com)
AWS_ACCESS_KEY_ID=minio_access_key
AWS_SECRET_ACCESS_KEY=minio_secret_key
AWS_S3_CUSTOM_DOMAIN=[minio.yourdomain.com/wagtail-media](https://minio.yourdomain.com/wagtail-media)

# ==============================================
# AI 大模型配置 (DeepSeek / Qwen) - 核心功能
# ==============================================
# DeepSeek 配置
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx
DEEPSEEK_BASE_URL=[https://api.deepseek.com/v1](https://api.deepseek.com/v1)
DEEPSEEK_MODEL=deepseek-chat

# 阿里千问配置 (可选备用)
QWEN_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx
QWEN_BASE_URL=[https://dashscope.aliyuncs.com/compatible-mode/v1](https://dashscope.aliyuncs.com/compatible-mode/v1)
QWEN_MODEL=qwen-plus

# AI 参数微调
AI_MAX_TOKENS=4096
AI_TEMPERATURE=0.7

# ==============================================
# 邮件服务 (SMTP)
# ==============================================
EMAIL_HOST=smtp.exmail.qq.com
EMAIL_PORT=465
EMAIL_HOST_USER=no-reply@yourdomain.com
EMAIL_HOST_PASSWORD=smtp_password
EMAIL_USE_SSL=True
DEFAULT_FROM_EMAIL=no-reply@yourdomain.com
```

## **4. 部署方案 A: Docker 容器化部署 (推荐)**

基于项目根目录的 `Dockerfile`，适合 Kubernetes 或 Docker Compose 环境。

### **4.1 构建镜像**

```bash
docker build -t wagtailblog:latest .
```

### **4.2 启动容器**

建议使用 `docker-compose.yml` (需自行创建) 或如下命令运行：

```bash
docker run -d \
  --name wagtail_app \
  --env-file .env \
  -p 8000:8000 \
  -v $(pwd)/media:/app/media \
  wagtailblog:latest
```

注意：`Dockerfile` 默认使用 Gunicorn 启动服务。

### **4.3 容器内初始化**

首次启动需进入容器执行初始化命令：

```bash
# 1. 进入容器
docker exec -it wagtail_app /bin/bash

# 2. 创建超级管理员
python manage.py createsuperuser

# 3. 初始化 MinIO 存储桶
python manage.py create_bucket

# 4. 重建 MongoDB 搜索索引 (如果从旧数据迁移)
python manage.py rebuild_mongodb_indexes
```

-----

## **5. 部署方案 B: 传统 Linux 部署 (Conda/uWSGI)**

适合使用宝塔面板 (Baota) 或传统运维习惯的场景。项目提供了 `uwsgi.ini` 和 `start.sh` 脚本。

### **5.1 环境准备**

1.  安装 Anaconda 或 Miniconda。
2.  创建并激活环境：
    ```bash
    conda create -n wagtailblog python=3.12
    conda activate wagtailblog
    ```
3.  安装依赖：
    ```bash
    # 基础依赖
    pip install -r requirements.txt
    # 生产服务器 (uWSGI 不在 requirements.txt 中，需单独安装)
    conda install uwsgi  # 或 pip install uwsgi
    ```

### **5.2 uWSGI 配置**

修改项目根目录下的 `uwsgi.ini`，确保路径与服务器实际路径一致：

```ini
[uwsgi]
# 修改为项目实际绝对路径
chdir=/www/wwwroot/wagtailblog 
# 虚拟环境路径
home=/root/anaconda3/envs/wagtailblog
# 指定 socket (配合 Nginx) 或 http (独立测试)
socket=%(chdir)/wagtailblog.sock
chmod-socket=666
# ...其他配置保持默认
```

### **5.3 启动服务**

可以使用提供的启动脚本，或配置为 Systemd 服务。

  * **脚本启动**:
    ```bash
    chmod +x start.sh
    ./start.sh
    ```
  * **Systemd 服务 (推荐)**:
    创建 `/etc/systemd/system/wagtail_uwsgi.service`:
    ```ini
    [Unit]
    Description=uWSGI instance to serve WagtailBlog
    After=network.target
    
    [Service]
    User=www-data
    Group=www-data
    WorkingDirectory=/www/wwwroot/wagtailblog
    Environment="PATH=/root/anaconda3/envs/wagtailblog/bin:/usr/local/bin:/usr/bin:/bin"
    ExecStart=/root/anaconda3/envs/wagtailblog/bin/uwsgi --ini uwsgi.ini
    
    [Install]
    WantedBy=multi-user.target
    ```

## **6. 异步任务 (Celery) 配置**

无论是 Docker 还是传统部署，**必须**启动 Celery Worker 和 Beat 以支持邮件发送和定时任务。

### **6.1 启动 Worker**

处理邮件发送、表单确认等异步任务。

```bash
# 命令行启动
celery -A wagtailblog3 worker -l INFO --logfile=logs/celery/worker.log
```

### **6.2 启动 Beat**

处理定时任务（如：同步阅读量 `sync_pageviews`、清理日志）。

```bash
# 命令行启动
celery -A wagtailblog3 beat -l INFO --logfile=logs/celery/beat.log
```

*注：在 Docker 中，通常需要运行单独的 Worker 和 Beat 容器，复用相同的镜像和环境变量。*

## **7. Nginx 反向代理配置**

```nginx
server {
    listen 80;
    server_name example.com;

    # 静态文件 (由 collectstatic 生成)
    location /static/ {
        alias /www/wwwroot/wagtailblog/staticfiles_collected/;
    }

    # 媒体文件 (若未使用云存储)
    location /media/ {
        alias /www/wwwroot/wagtailblog/media/;
    }

    # 主应用 (uWSGI 模式)
    location / {
        include uwsgi_params;
        uwsgi_pass unix:/www/wwwroot/wagtailblog/wagtailblog.sock;
        # 若使用 Gunicorn/Docker，改为:
        # proxy_pass [http://127.0.0.1:8000](http://127.0.0.1:8000);
        # include proxy_params;
    }
}
```

## **8. 常见运维操作**

### **8.1 更新代码流程**

```bash
git pull origin main
pip install -r requirements.txt  # 更新依赖
python manage.py migrate         # 数据库迁移
python manage.py collectstatic --noinput  # 收集静态资源
# 重启服务
sudo systemctl restart wagtail_uwsgi celery_worker
```

### **8.2 关键管理命令**

  * **重建搜索索引 (MongoDB)**:
    当发现搜索结果不准确或迁移数据后执行。
    ```bash
    python manage.py rebuild_mongodb_indexes
    ```
  * **同步阅读量**:
    将 Redis 中的计数持久化到 MySQL。
    ```bash
    python manage.py sync_pageviews
    ```
  * **清理日志**:
    ```bash
    python manage.py clean_logs --days 30
    ```

### **8.3 AI 功能排查**

如果 AI 辅助写作功能失效，请检查：

1.  `.env` 中 `DEEPSEEK_API_KEY` 是否过期。
2.  查看 `logs/system/error.log` 中是否有 API 连接超时记录。
3.  确认服务器能够访问 `https://api.deepseek.com` (需检查防火墙出站规则)。
