# **博客系统 - 详细设计说明书 (DDD)**

**版本: 2.0**

**日期: 2025-06-14**

**修订人: System Architect**

## **1. 引言 (Introduction)**

### **1.1 目的 (Purpose)**
本文档旨在为“Wagtail博客系统”的开发人员提供详细的技术实现指导。它在《概要设计说明书》的基础上，对系统中的核心模块、类和函数进行了深入的设计和阐述，明确了内部实现逻辑、接口契约和关键算法。

### **1.2 范围 (Scope)**
本文档的范围涵盖了所有核心业务模块的内部设计，主要包括：
* 博客内容管理 (`apps.blog`)：含混合存储与互动逻辑。
* 评论系统 (`apps.comments`)：含树状回复与状态管理。
* 搜索功能 (`apps.search`)：含混合搜索策略与建议。
* 基础功能和异步任务 (`apps.base`)：含邮件服务与Celery任务。

---

## **2. 模块详细设计: `apps.blog` (博客核心)**

### **2.1 模块概述**
`blog` 应用是系统的核心，负责文章的混合存储（MySQL+MongoDB）、展示渲染、以及用户互动（点赞/反应）。

### **2.2 核心类设计：`models.BlogPage`**
* **文件**: `apps/blog/models.py`
* **继承**: `wagtail.models.Page`
* **关键属性**:
    * `mongo_content_id`: `CharField` - 存储在 MongoDB 中对应文档的 ObjectId。
    * `body`: `StreamField` (定义) - 在内存中用于编辑器交互，**数据库中不直接存储内容**。
    * `reaction_counts`: (运行时属性) - 通过聚合查询动态获取的反应统计。

* **关键方法设计**:

    * **`save(self, *args, **kwargs)` (双写逻辑)**:
        1.  **提取内容**: 从 `self.body` 获取 StreamField 的原始 JSON 数据。
        2.  **写入 MongoDB**: 调用 `MongoManager().save_blog_content()`，将 `title`, `intro`, `body` (JSON), `tokens` (分词) 写入 MongoDB。
        3.  **获取 ID**: 获取 MongoDB 返回的 `ObjectId`。
        4.  **清空字段**: 将 `self.body` 临时置空（或保留极简结构），避免 MySQL 存储大文本。
        5.  **写入 MySQL**: 更新 `self.mongo_content_id`，调用 `super().save()` 将元数据写入 MySQL。

    * **`serve(self, request)` (读时合并)**:
        1.  **获取内容**: 调用 `self.get_content_from_mongodb()` 使用 `mongo_content_id` 拉取正文。
        2.  **渲染 Markdown**: 遍历内容块，对 `markdown_block` 进行服务端渲染（CommonMark + Pygments）。
        3.  **数据注入**: 将处理后的数据重新填充到 `self.body`，使其表现得像原生 Wagtail 页面一样。
        4.  **响应**: 调用 `super().serve(request)` 渲染模板。

### **2.3 视图与API设计：`apps.blog.views`**

#### **2.3.1 `toggle_reaction(request, page_id)`**
* **类型**: AJAX API (POST)
* **描述**: 处理用户点击“点赞/鼓掌”等反应图标的逻辑。
* **逻辑**:
    1.  **身份识别**: 优先使用 `request.user`；若未登录，使用 `request.session.session_key` + IP 进行指纹识别。
    2.  **状态判定**: 查询 `Reaction` 表。
        * *无记录*: **Create** (Action: 'added')。
        * *有记录且类型相同*: **Delete** (Action: 'removed') - 取消点赞。
        * *有记录且类型不同*: **Update** (Action: 'changed') - 修改反应类型。
    3.  **返回**: JSON 包含操作结果及该页面最新的各类反应计数。

#### **2.3.2 `AuthorListView`**
* **继承**: `django.views.generic.ListView`
* **功能**: 展示作者列表，支持按姓名搜索 (`?q=...`)。

---

## **3. 模块详细设计: `apps.comments` (评论系统)**

### **3.1 模块概述**
`comments` 应用独立于 Wagtail 内置评论，实现了支持无限/多级嵌套的评论系统。

### **3.2 模型设计：`BlogPageComment`**
* **文件**: `apps/comments/models.py`
* **关键属性**:
    * `parent`: `ForeignKey('self')` - 实现树状结构。
    * `path`: (逻辑属性) - 虽未显式定义，但通过递归模板渲染实现层级展示。
    * `can_edit_until`: `DateTimeField` - 允许用户在发布后5分钟内编辑。
    * `status`: `CharField` - `approved` (默认), `deleted`, `pending`。

### **3.3 核心逻辑**
* **删除逻辑 (`real_delete`)**:
    * 不直接物理删除，而是递归处理子评论。
    * 更新父评论的 `reply_count` 字段（使用 `F` 表达式保证原子性）。
    * 删除关联的 `CommentReaction`。

---

## **4. 模块详细设计: `apps.search` (搜索功能)**

### **4.1 模块概述**
`search` 模块封装了复杂的搜索逻辑，支持混合后端（Wagtail ORM / MongoDB），并提供搜索建议和高亮功能。

### **4.2 核心函数：`core.perform_search`**
* **文件**: `apps/search/core.py`
* **签名**: `perform_search(query_string, search_type='all', ...)`
* **逻辑流程**:
    1.  **记录查询**: 将 `query_string` 写入 `Query` 模型（用于热门搜索统计）。
    2.  **基础搜索**:
        * 调用 `Page.objects.live().search(query_string)`。这里实际上委托给了配置的 `CustomSearchBackend`。
    3.  **高级过滤 (Post-Filtering)**:
        * **类型过滤**: 根据 `search_type` ('blog', 'pages') 筛选结果。
        * **日期过滤**: 若传入 `start_date`/`end_date`，手动过滤 QuerySet 结果 ID（区分 BlogPage 和普通 Page）。
    4.  **混合排序**:
        * 若 `order_by='-date'`: 分离 BlogPage (按 `date`) 和普通 Page (按 `first_published_at`)，分别排序后合并，并利用 `Case/When` 保持 ID 顺序重构 QuerySet。
    5.  **返回**: 保持为 Wagtail 的 `SearchResults` 或 Django `QuerySet` 接口。

### **4.3 辅助功能**
* **`get_search_suggestions(query_string)`**:
    * 查询 `wagtail.contrib.search_promotions.Query` 模型。
    * 聚合 `daily_hits`，返回最热门的前 N 个匹配词。
* **`format_search_results_for_api`**:
    * 将搜索结果序列化为 JSON 友好的字典，处理 `featured_image` URL 和 `date` 格式化。

---

## **5. 模块详细设计: `apps.base` (基础与异步任务)**

### **5.1 异步任务设计 (`apps.base.tasks`)**
利用 Celery 处理耗时操作，避免阻塞 HTTP 请求。

#### **5.1.1 `send_form_confirmation_email`**
* **装饰器**: `@shared_task(bind=True, max_retries=3)`
* **功能**: 发送表单提交确认信给用户。
* **逻辑**:
    1.  **渲染**: 使用 `emails/form_confirmation.html` 模板渲染 HTML 内容。
    2.  **构建**: 创建 `EmailMultiAlternatives` 对象，附加 HTML 和纯文本版本。
    3.  **发送**: 调用 SMTP 发送。
    4.  **重试**: 捕获 `SMTPException`，若失败则触发 `self.retry`，指数退避重试。

#### **5.1.2 `send_admin_notification_email`**
* **功能**: 独立任务，通知管理员有新表单提交。
* **设计理由**: 与用户确认邮件分离，互不影响；若管理员邮件发送失败，不应影响给用户的反馈。

### **5.2 表单页面设计 (`models.FormPage`)**
* **文件**: `apps/base/models.py`
* **继承**: `wagtail.contrib.forms.models.AbstractEmailForm`
* **增强逻辑 (`process_form_submission`)**:
    * 重写默认处理逻辑。
    * 从 `form.cleaned_data` 或 `submission` 中智能提取用户邮箱。
    * **触发异步任务**: 调用 `send_form_confirmation_email.apply_async()` 而非同步发送。

---

## **6. 前端交互设计 (JavaScript)**

### **6.1 搜索交互 (`static/search/js/search.js`)**
* **自动完成 (Typeahead)**:
    * 监听输入框 `input` 事件。
    * Debounce (防抖) 处理，延迟 300ms 请求 `/search/suggest/`。
    * 渲染下拉建议列表。

### **6.2 评论交互 (`static/comments/js/comments.js`)**
* **AJAX 提交**: 拦截表单 submit，使用 `fetch` 提交评论。
* **动态插入**: 成功后直接将返回的 HTML 片段插入 DOM 树，无需刷新页面。
* **回复**: 点击回复按钮，动态移动评论表单至对应评论下方，并设置隐藏域 `parent_id`。

### **6.3 Mermaid 图表渲染 (`static/blog/js/mermaid_block.js`)**
* **初始化**: 页面加载后扫描所有 `.mermaid-block` 容器。
* **渲染**: 读取容器内的原始代码文本，调用 `mermaid.init()` 生成 SVG 图表。