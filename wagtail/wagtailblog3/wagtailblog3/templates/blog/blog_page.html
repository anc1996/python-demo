{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags static blog_tags comment_tags %}
{% block title %}{{ page.title }}{% endblock %}



{% block extra_css %}



    <!-- markdownæ ·å¼ -->
    <link rel="stylesheet" href="{% static 'blog/css/markdown-theme.css' %}">

    <link rel="stylesheet" href="{% static 'blog/css/rich-text-theme.css' %}">

    <!-- å…¶ä»–åŠŸèƒ½æ ·å¼ -->
    <link rel="stylesheet" href="{% static 'blog/css/katex/katex.min.css' %}">
    <link rel="stylesheet" href="{% static 'blog/css/lightbox/lightbox.css' %}">
    <link rel="stylesheet" href="{% static 'blog/css/jquery-ui/jquery-ui.css' %}">

    <!-- åšå®¢æ ¸å¿ƒæ ·å¼ -->
    <link rel="stylesheet" href="{% static 'blog/css/blog.css' %}">
    <link rel="stylesheet" href="{% static 'blog/css/image_blocks.css' %}">
    <link rel="stylesheet" href="{% static 'blog/css/video_blocks.css' %}">
    <link rel="stylesheet" href="{% static 'blog/css/audio_blocks.css' %}">
    <link rel="stylesheet" href="{% static 'blog/css/embed_blocks.css' %}">
    <link rel="stylesheet" href="{% static 'blog/css/table_blocks.css' %}">

    <!-- è¯„è®ºæ¨¡å—æ ·å¼ -->
    <link rel="stylesheet" href="{% static 'comments/css/comments.css' %}">

    {{ block.super }}


    {% block custom_scrollbar_assets_css %}
    {# æ­¤å—ç•™ç©ºï¼Œä»¥é˜»æ­¢åœ¨åšå®¢é¡µé¢ä¸ŠåŠ è½½ mCustomScrollbar.css #}
    {% endblock custom_scrollbar_assets_css %}

{% endblock %}

{% block content %}
<div class="blog-page-wrapper">
    <!-- åšå®¢å¤´éƒ¨åŒºåŸŸ -->
    <section class="blog-hero">
        {% if page.featured_image %}
            {% image page.featured_image original class="blog-featured-image" %}
        {% endif %}

        <div class="blog-container">
            <div class="blog-hero-content">
                <h1 class="blog-title">{{ page.title }}</h1>

                {% if page.intro %}
                    <p class="blog-intro">{{ page.intro }}</p>
                {% endif %}

                <div class="blog-meta">
                    <div class="blog-meta-item">
                        <i class="fa fa-calendar"></i>
                        <span>{{ page.date|date:"Yå¹´mæœˆdæ—¥" }}</span>
                    </div>

                    {% if page.authors.all %}
                        <div class="blog-meta-item">
                            <i class="fa fa-user"></i>
                            <span>
                                {% for author in page.authors.all %}
                                    {{ author.name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </span>
                        </div>
                    {% endif %}

                    <div class="blog-meta-item">
                        <i class="fa fa-eye"></i>
                        <span>{{ page.get_view_count.total }} æ¬¡æµè§ˆ</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="blog-container">
        <article class="blog-main">
            <!-- StreamField å†…å®¹ -->
            <div class="blog-content-area">
                <div class="content-blocks">
                    {% for block in page.body %}
                        <div class="content-block-wrapper" data-block-type="{{ block.block_type }}"
                             {% if block.block_type == "image_block" and block.value.alt %}data-image-title="{{ block.value.alt }}"{% endif %}>
                            {% include_block block %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- å›¾ç‰‡ç”»å»Š -->
            {% if page.gallery_images.all %}
                <div class="blog-gallery">
                    <h4><i class="fa fa-images"></i> å›¾ç‰‡ç”»å»Š</h4>
                    <div class="gallery-grid">
                        {% for gallery_image in page.gallery_images.all %}
                            <div class="gallery-item">
                                <a href="{% image_url gallery_image.image 'original' %}"
                                   data-lightbox="gallery"
                                   data-title="{{ gallery_image.caption }}">
                                    {% image gallery_image.image width-400 %}
                                </a>
                                {% if gallery_image.caption %}
                                    <p class="caption">{{ gallery_image.caption }}</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}


        </article>

        <!-- æ–‡ç« åº•éƒ¨äº’åŠ¨åŒºåŸŸ -->
        <div class="blog-interactions">
            <!-- è®¿é—®ç»Ÿè®¡ -->
            {% include 'blog/stats_block.html' %}

            <!-- ååº”æŒ‰é’® -->
            {% include 'blog/reactions_block.html' %}

            <!-- ç›¸å…³æ–‡ç« æ¨è -->
            {% with related_posts=page.get_related_posts_by_tags %}
                {% if related_posts %}
                    <div class="related-posts">
                        <h3><i class="fa fa-lightbulb"></i> ç›¸å…³æ¨è</h3>
                        <div class="related-posts-grid">
                            {% for post in related_posts %}
                                <article class="related-post-item">
                                    <a href="{{ post.url }}" class="related-post-link">
                                        {% if post.featured_image %}
                                            {% image post.featured_image width-200 class="related-post-image" %}
                                        {% endif %}
                                        <div class="related-post-content">
                                            <h4>{{ post.title }}</h4>
                                            <p>{{ post.intro|truncatewords:15 }}</p>
                                            <span class="related-post-date">{{ post.date|date:"Y-m-d" }}</span>
                                        </div>
                                    </a>
                                </article>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endwith %}

            <!-- ä¸Šä¸€ç¯‡/ä¸‹ä¸€ç¯‡å¯¼èˆª -->
            {% with prev_post=page.get_prev_post next_post=page.get_next_post %}
                {% if prev_post or next_post %}
                    <nav class="post-navigation">
                        {% if prev_post %}
                            <a href="{{ prev_post.url }}" class="nav-link nav-prev">
                                <i class="fa fa-chevron-left"></i>
                                <div>
                                    <span class="nav-label">ä¸Šä¸€ç¯‡</span>
                                    <span class="nav-title">{{ prev_post.title }}</span>
                                </div>
                            </a>
                        {% endif %}

                        {% if next_post %}
                            <a href="{{ next_post.url }}" class="nav-link nav-next">
                                <div>
                                    <span class="nav-label">ä¸‹ä¸€ç¯‡</span>
                                    <span class="nav-title">{{ next_post.title }}</span>
                                </div>
                                <i class="fa fa-chevron-right"></i>
                            </a>
                        {% endif %}
                    </nav>
                {% endif %}
            {% endwith %}

               <div class="blog-comments"> {# ä¿ç•™åŸæœ‰å®¹å™¨ #}
                    {% render_comments page %}
                </div>

        </div>
    </div>
</div>
{% endblock %}



{% block extra_js %}
    {{ block.super }}

    {% block custom_scrollbar_assets_js %}
    {# æ­¤å—ç•™ç©ºï¼Œä»¥é˜»æ­¢åœ¨åšå®¢é¡µé¢ä¸ŠåŠ è½½ mCustomScrollbar.js #}
    {% endblock custom_scrollbar_assets_js %}

    <script src="{% static 'blog/css/katex/katex.js' %}" async></script>
    <script src="{% static 'blog/js/katex/auto-render.min.js' %}" async></script>
    <script src="{% static 'blog/js/lightbox/lightbox.js' %}" async></script>
    <script src="{% static 'blog/js/jquery-ui/jquery-ui.js' %}" async></script>

    <script src="{% static 'blog/js/mermaid.min.js' %}" async></script>

    <script src="{% static 'blog/js/image_blocks.js' %}" async></script>
    <script src="{% static 'blog/js/video_blocks.js' %}" async></script>
    <script src="{% static 'blog/js/editor-enhancements.js' %}" async></script>

    <script src="{% static 'comments/js/comments.js' %}" defer></script> {# defer ç¡®ä¿DOMåŠ è½½åå†æ‰§è¡Œ #}

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // (A) åˆå§‹åŒ– Mermaid.js (ç”¨äºå›¾è¡¨)
            try {
                mermaid.initialize({ startOnLoad: true });
            } catch (e) {
                console.error("Mermaid.js åˆå§‹åŒ–å¤±è´¥: ", e);
            }

            // (B) åˆå§‹åŒ– KaTeX (ç”¨äºæ•°å­¦å…¬å¼)
            try {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "\\(", right: "\\)", display: false},
                        {left: "$", right: "$", display: false},
                        {left: "\\[", right: "\\]", display: true}
                    ],
                    throwOnError: false
                });
            } catch (e) {
                console.error("KaTeX æ¸²æŸ“å¤±è´¥: ", e);
            }

            // ğŸš€ (C) ã€æ–°å¢ã€‘ä¸º Markdown è¡¨æ ¼è‡ªåŠ¨åº”ç”¨æ‚¨ç½‘ç«™çš„æ—¢æœ‰ä¸»é¢˜æ ·å¼
            try {
                // 1. ç²¾ç¡®æ‰¾åˆ°æ‰€æœ‰åœ¨ Markdown å—å†…éƒ¨ã€ä¸”è‡ªèº«æ²¡æœ‰ class çš„æœ´ç´ è¡¨æ ¼
                const markdownTables = document.querySelectorAll(
                    '.content-block-wrapper[data-block-type="markdown_block"] table:not([class])'
                );

                markdownTables.forEach(table => {
                    // 2. ä¸ºè¿™äº›è¡¨æ ¼ç©¿ä¸Šæ‚¨ç½‘ç«™å·²æœ‰çš„ Bootstrap æ ·å¼
                    table.classList.add('table', 'table-bordered', 'table-hover');

                    // 3. (å¯é€‰ä½†æ¨è) ä¸ºè¡¨æ ¼æ·»åŠ å“åº”å¼åŒ…è£¹å±‚ï¼Œä½¿å…¶åœ¨æ‰‹æœºä¸Šå¯ä»¥å·¦å³æ»‘åŠ¨
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-responsive';
                    table.parentNode.insertBefore(wrapper, table);
                    wrapper.appendChild(table);
                });
            } catch (e) {
                console.error("è‡ªåŠ¨ç¾åŒ– Markdown è¡¨æ ¼å¤±è´¥: ", e);
            }

        });
    </script>
{% endblock %}