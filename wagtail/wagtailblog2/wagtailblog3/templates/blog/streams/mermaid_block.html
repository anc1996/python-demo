{% load mermaid %}

<div class="mermaid-diagram-wrapper" style="
    border: 2px solid #0066cc;
    border-radius: 8px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    margin: 20px 0;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    position: relative;
">
    {# æ ‡é¢˜æ å’Œæ§åˆ¶æŒ‰é’® #}
    <div class="mermaid-header" style="
        background: #0066cc;
        color: white;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        user-select: none;
    " onclick="this.parentElement.querySelector('.mermaid-content').classList.toggle('collapsed'); this.querySelector('.toggle-icon').textContent = this.parentElement.querySelector('.mermaid-content').classList.contains('collapsed') ? 'â–¼' : 'â–²';">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span class="toggle-icon" style="font-size: 14px;">â–²</span>
            <span style="font-weight: bold; font-size: 16px;">ğŸ“Š Mermaid å›¾è¡¨</span>
        </div>
        <div style="font-size: 12px; opacity: 0.9;">ç‚¹å‡»æŠ˜å /å±•å¼€</div>
    </div>

    {# å†…å®¹åŒºåŸŸ #}
    <div class="mermaid-content" style="
        padding: 20px;
        background: white;
        transition: all 0.3s ease;
        max-height: 5000px;
        overflow: hidden;
    ">
        {# è°ƒè¯•é¢æ¿ #}
        <details style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 4px; border-left: 4px solid #0066cc;">
            <summary style="cursor: pointer; font-weight: bold; color: #0066cc; outline: none;">
                ğŸ› æŸ¥çœ‹åŸå§‹ä»£ç 
            </summary>
            <pre style="background: white; padding: 15px; overflow-x: auto; margin-top: 10px; white-space: pre-wrap; word-wrap: break-word; border: 1px solid #e0e0e0; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 13px;">{{ value.code }}</pre>
            <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                ğŸ’¡ å¦‚æœå›¾è¡¨æœªæ˜¾ç¤ºï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„ä»£ç è¯­æ³•æ˜¯å¦æ­£ç¡®
            </p>
        </details>

        {# ç¼©æ”¾æ§åˆ¶æŒ‰é’® #}
        <div class="zoom-controls" style="
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #f0f4f8;
            border-radius: 4px;
        ">
            <span style="font-weight: bold; color: #333; font-size: 14px;">ç¼©æ”¾æ§åˆ¶ï¼š</span>
            <button onclick="event.stopPropagation(); zoomMermaid(this, 'in')" style="
                padding: 8px 16px;
                background: #0066cc;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: background 0.2s;
            " onmouseover="this.style.background='#0052a3'" onmouseout="this.style.background='#0066cc'">
                ğŸ” æ”¾å¤§
            </button>
            <button onclick="event.stopPropagation(); zoomMermaid(this, 'out')" style="
                padding: 8px 16px;
                background: #0066cc;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: background 0.2s;
            " onmouseover="this.style.background='#0052a3'" onmouseout="this.style.background='#0066cc'">
                ğŸ” ç¼©å°
            </button>
            <button onclick="event.stopPropagation(); zoomMermaid(this, 'reset')" style="
                padding: 8px 16px;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: background 0.2s;
            " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                â†º é‡ç½®
            </button>
            <span class="zoom-level" style="
                margin-left: 10px;
                padding: 6px 12px;
                background: white;
                border-radius: 4px;
                font-weight: bold;
                color: #0066cc;
                font-size: 14px;
            ">100%</span>
        </div>

        {# Mermaid å›¾è¡¨å®¹å™¨ #}
        <div class="mermaid-chart-container" style="
            text-align: center;
            overflow: auto;
            padding: 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            min-height: 200px;
        ">
            <div class="mermaid-inner" style="
                transform: scale(1);
                transform-origin: center center;
                transition: transform 0.3s ease;
                display: inline-block;
            ">
                {% mermaid value.code %}
            </div>
        </div>
    </div>
</div>

<style>
    /* æŠ˜å çŠ¶æ€æ ·å¼ */
    .mermaid-content.collapsed {
        max-height: 0 !important;
        padding: 0 20px !important;
        opacity: 0;
    }

    /* é˜²æ­¢ç‚¹å‡»æ§åˆ¶æŒ‰é’®æ—¶è§¦å‘æŠ˜å  */
    .zoom-controls button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
</style>

<script>
    // ç¼©æ”¾æ§åˆ¶å‡½æ•° - é™å®šåœ¨å½“å‰å›¾è¡¨å®¹å™¨å†…
    function zoomMermaid(button, action) {
        // è·å–å½“å‰æŒ‰é’®æ‰€åœ¨çš„ wrapper
        const wrapper = button.closest('.mermaid-diagram-wrapper');
        const chartInner = wrapper.querySelector('.mermaid-inner');
        const zoomLevelDisplay = wrapper.querySelector('.zoom-level');

        // è·å–å½“å‰ç¼©æ”¾çº§åˆ«
        const currentTransform = window.getComputedStyle(chartInner).transform;
        let currentScale = 1;

        if (currentTransform !== 'none') {
            const matrix = currentTransform.match(/matrix\(([^)]+)\)/);
            if (matrix) {
                const values = matrix[1].split(',');
                currentScale = parseFloat(values[0]);
            }
        }

        // è®¡ç®—æ–°çš„ç¼©æ”¾çº§åˆ«
        let newScale = currentScale;
        const zoomStep = 0.2;
        const minScale = 0.2;
        const maxScale = 3.0;

        switch(action) {
            case 'in':
                newScale = Math.min(currentScale + zoomStep, maxScale);
                break;
            case 'out':
                newScale = Math.max(currentScale - zoomStep, minScale);
                break;
            case 'reset':
                newScale = 1;
                break;
        }

        // åº”ç”¨æ–°çš„ç¼©æ”¾
        chartInner.style.transform = `scale(${newScale})`;

        // æ›´æ–°æ˜¾ç¤ºçš„ç¼©æ”¾çº§åˆ«
        zoomLevelDisplay.textContent = `${Math.round(newScale * 100)}%`;

        // å¦‚æœæ”¾å¤§è¶…è¿‡å®¹å™¨ï¼Œæ˜¾ç¤ºæ»šåŠ¨æç¤º
        if (newScale > 1.5) {
            const container = wrapper.querySelector('.mermaid-chart-container');
            container.style.cursor = 'move';
        }
    }

    // å¯é€‰ï¼šæ·»åŠ é¼ æ ‡æ‹–åŠ¨åŠŸèƒ½ï¼ˆä»…åœ¨æ”¾å¤§æ—¶ï¼‰
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.mermaid-chart-container').forEach(container => {
            let isDragging = false;
            let startX, startY, scrollLeft, scrollTop;

            container.addEventListener('mousedown', function(e) {
                const chartInner = this.querySelector('.mermaid-inner');
                const scale = parseFloat(window.getComputedStyle(chartInner).transform.match(/matrix\(([^)]+)\)/)?.[1].split(',')[0] || 1);

                if (scale > 1.2) {  // ä»…åœ¨æ”¾å¤§æ—¶å¯ç”¨æ‹–åŠ¨
                    isDragging = true;
                    startX = e.pageX - container.offsetLeft;
                    startY = e.pageY - container.offsetTop;
                    scrollLeft = container.scrollLeft;
                    scrollTop = container.scrollTop;
                    container.style.cursor = 'grabbing';
                }
            });

            container.addEventListener('mouseleave', () => {
                isDragging = false;
                const chartInner = container.querySelector('.mermaid-inner');
                const scale = parseFloat(window.getComputedStyle(chartInner).transform.match(/matrix\(([^)]+)\)/)?.[1].split(',')[0] || 1);
                container.style.cursor = scale > 1.2 ? 'move' : 'default';
            });

            container.addEventListener('mouseup', () => {
                isDragging = false;
                const chartInner = container.querySelector('.mermaid-inner');
                const scale = parseFloat(window.getComputedStyle(chartInner).transform.match(/matrix\(([^)]+)\)/)?.[1].split(',')[0] || 1);
                container.style.cursor = scale > 1.2 ? 'move' : 'default';
            });

            container.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - container.offsetLeft;
                const y = e.pageY - container.offsetTop;
                const walkX = (x - startX) * 2;
                const walkY = (y - startY) * 2;
                container.scrollLeft = scrollLeft - walkX;
                container.scrollTop = scrollTop - walkY;
            });
        });
    });
</script>