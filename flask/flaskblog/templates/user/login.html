{% extends 'base.html' %}
{% block title %}
    登录页面
{% endblock %}

{% block content %}
<main class="row content__page">
    <section class="column large-full entry format-standard">
        <h2>登录页面</h2>

        <!-- 登录方式选择 -->
        <div class="login-method-selector">
            <button class="btn--primary" id="username-login-btn">用户名密码登录</button>
            <button class="btn--primary" id="phone-login-btn">手机验证码登录</button>
        </div>

        <!-- 用户名密码登录表单 -->
        <form id="username-login-form" action="{{ url_for('user.login',type='username') }}" method="post" style="display: none;">
            <div>
                <label for="InputUsername">用户名：</label>
                <input class="full-width" type="text" id="InputUsername" name="username" placeholder="用户名">
                <span></span>
            </div>
            <div>
                <label for="InputPassword">密码：</label>
                <input class="full-width" type="password" id="InputPassword" name="password" placeholder="密码">
                <span></span>
            </div>
            <div>
                <input class="btn--primary full-width" type="submit" value="登录">
            </div>
        </form>

        <!-- 手机验证码登录表单 -->
        <form id="phone-login-form" action="{{ url_for('user.login',type="phone") }}" method="post" style="display: none;">
            <div class="form-group">
                <label for="InputPhone">手机号：</label>
                <input class="full-width" type="text" id="InputPhone" name="phone" placeholder="请输入手机号">
                <span id="error_phone" class="error"></span>
            </div>
            <div class="form-group">
                <label for="sms-provider">选择短信服务商：</label>
                <select id="sms-provider" name="sms_provider">
                    <option value="netease">网易短信</option>
                    <option value="ali">阿里短信</option>
                </select>
            </div>
            <div class="form-group phone-code-input">
                <label for="InputCode">验证码：</label>
                <input class="full-width" type="text" id="InputCode" name="code" placeholder="请输入验证码">
                <button type="button" class="btn--primary" id="send-code-btn">发送验证码</button>
                <span id="error_code" class="error"></span>
            </div>

            <div class="form-group">
                <input class="btn--primary full-width" type="submit" value="登录">
            </div>
        </form>

        {# 错误提示 #}
        {% if error_login_msg %}
            <div class="alert-box alert-box--error hideit">
                {{ error_login_msg }}。
                <i class="fa fa-times alert-box__close" aria-hidden="true"></i>
            </div><!-- end error -->
        {% endif %}
    </section>
</main>
{% endblock %}


{% block footer %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/user.js') }}"></script>
    <script>
        $(document).ready(function() {
            // 选择登录方式
            $('#username-login-btn').click(function() {
                $('#username-login-form').show();
                $('#phone-login-form').hide();
            });

            $('#phone-login-btn').click(function() {
                $('#phone-login-form').show();
                $('#username-login-form').hide();
            });

            // 发送验证码按钮的逻辑
            $('#send-code-btn').click(function() {
                sendVerificationCode();
            });


            // 发送验证码的逻辑
            function sendVerificationCode() {
                let phone = $('#InputPhone').val();
                let sms_provider = $('#sms-provider').val();
                let phone_error = $('#error_phone');

                // 清空之前的错误信息
                phone_error.text('');

                // 验证手机号格式
                if (!checkPhoneFormat('#InputPhone', '#error_phone')) {
                    return;
                }

                $.ajax({
                    url: "{{ url_for('user.sendmsg') }}",
                    type: 'POST',
                    data: {
                        phone: phone,
                        sms_provider: sms_provider
                    },
                    success: function(response) {
                        if (response.status == 200) {
                            alert('验证码发送成功');
                            startCountdown();
                        } else {
                            alert('验证码发送失败: ' + response.sms_status);
                        }
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = '验证码发送失败: ';
                        if (xhr.responseJSON && xhr.responseJSON.sms_status) {
                            errorMessage += xhr.responseJSON.sms_status;
                        } else {
                            errorMessage += error;
                        }
                        alert(errorMessage);
                    }
                });
            }

            // 检查用户名和密码是否为空
            $('#InputUsername').blur(function() {
                let isUsernameValid=checkEmptyInput('#InputUsername', 'span','用户名不能为空');
            });

            // 检查密码是否为空
            $('#InputPassword').blur(function() {
                let isPasswordValid=checkEmptyInput('#InputPassword', 'span','密码不能为空');
            });

            // 检查手机号码格式
            $('#InputPhone').blur(function() {
                let isPhoneValid=checkPhoneFormat('#InputPhone', 'span');
            });

            // 检查验证码格式
            $('#InputCode').blur(function() {
                let isCodeValid=checkCodeFormat('#InputCode', '#error_code');
            });

        });
    </script>
{% endblock %}